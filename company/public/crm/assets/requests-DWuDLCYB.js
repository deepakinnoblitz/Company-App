import{f as S,H as $,r,j as e,B as l,d as Y,v as R,I as p,T as h,D as ke,p as B,S as qe,q as De,w as _e}from"./index-Co7v2xsC.js";import{C as Te}from"./config-global-BX9xwJzv.js";import{h as z}from"./api-error-handler-CV6pRVHb.js";import{f as Pe}from"./hr-management-CfgPc5UQ.js";import{D as Ee,C as Ie}from"./Card-CDV3jV6O.js";import{E as Oe}from"./empty-content-BBDmaj4d.js";import{C as Fe}from"./confirm-dialog--19ddTk_.js";import{U as Ne,a as We,b as Ae,T as Be}from"./user-table-toolbar-BXgkag6p.js";import{L as Z}from"./label-BpZ9ieER.js";import"./styles-wAmuuHpw.js";import{c as ee,d as j,T as Le,a as $e,e as ze}from"./TableRow-DqeBPnxy.js";import{C as Me}from"./Checkbox-CoJXcvzD.js";import{D as te,a as se}from"./DialogContent-DtP-sWqR.js";import{D as ae}from"./DialogTitle-C3eBZids.js";import{T as He}from"./TablePagination-CEaYVDlQ.js";import{F as Je,a as Ue,S as Ve}from"./Select-B1EkSlUY.js";import{T as K}from"./TextField-BmVWmDzd.js";import{D as Ge}from"./DialogActions-h_2rRG3x.js";import{S as Qe}from"./Snackbar-BVA3LOhi.js";import"./useFormControl-Cqn8lfES.js";import"./Popper-DDlcgFVJ.js";import"./Badge-DIppMJwA.js";import"./usePreviousProps-CVIlMhUg.js";import"./KeyboardArrowRight-CBVMFcL2.js";import"./LastPage-CUGiC0iB.js";async function Ye(s){const o=[];s.search&&o.push([["Request","subject","like",`%${s.search}%`],["or",["Request","employee_name","like",`%${s.search}%`]]]);const a=s.orderBy&&s.order?`${s.orderBy} ${s.order}`:"creation desc",i=new URLSearchParams({doctype:"Request",fields:JSON.stringify(["*"]),filters:JSON.stringify(o),limit_start:String((s.page-1)*s.page_size),limit_page_length:String(s.page_size),order_by:a}),[n,m]=await Promise.all([S(`/api/method/frappe.client.get_list?${i.toString()}`),S(`/api/method/frappe.client.get_count?doctype=Request&filters=${encodeURIComponent(JSON.stringify(o))}`)]);if(!n.ok)throw new Error("Failed to fetch requests");const x=await n.json(),y=await m.json();return{data:x.message||[],total:y.message||0}}const Ke=s=>Ye(s);async function Xe(s){const o=await $(),a=await S("/api/method/frappe.client.insert",{method:"POST",headers:o,body:JSON.stringify({doc:{doctype:"Request",...s}})});if(!a.ok){const i=await a.json();throw new Error(z(i,"Failed to create request"))}return(await a.json()).message}async function Ze(s,o){const a=await $(),i=await S("/api/method/frappe.client.set_value",{method:"POST",headers:a,body:JSON.stringify({doctype:"Request",name:s,fieldname:o})});if(!i.ok){const n=await i.json();throw new Error(z(n,"Failed to update request"))}return(await i.json()).message}async function X(s){const o=await $(),a=await S("/api/method/frappe.client.delete",{method:"POST",headers:o,body:JSON.stringify({doctype:"Request",name:s})});if(!a.ok){const i=await a.json();throw new Error(z(i,"Failed to delete request"))}return!0}async function et(){const s=await S("/api/method/company.company.frontend_api.get_doc_permissions?doctype=Request");return s.ok?(await s.json()).message||{read:!1,write:!1,delete:!1}:{read:!1,write:!1,delete:!1}}function tt(s,o,a,i,n){const[m,x]=r.useState([]),[y,b]=r.useState(0),[w,c]=r.useState(!0),f=r.useCallback(async()=>{c(!0);try{const u=await Ke({page:s,page_size:o,search:a,orderBy:i,order:n});x(u.data),b(u.total)}catch(u){console.error("Failed to fetch requests:",u)}finally{c(!1)}},[s,o,a,i,n]);return r.useEffect(()=>{f()},[f]),{data:m,total:y,loading:w,refetch:f}}function st({row:s,selected:o,onSelectRow:a,onView:i,onEdit:n,onDelete:m,canEdit:x,canDelete:y,hideCheckbox:b=!1,index:w}){return e.jsxs(ee,{hover:!0,tabIndex:-1,role:"checkbox",selected:o,children:[!b&&e.jsx(j,{padding:"checkbox",children:e.jsx(Me,{disableRipple:!0,checked:o,onChange:a})}),typeof w=="number"&&e.jsx(j,{align:"center",children:e.jsx(l,{sx:{width:28,height:28,display:"flex",borderRadius:"50%",alignItems:"center",justifyContent:"center",bgcolor:c=>Y(c.palette.primary.main,.08),color:"primary.main",typography:"subtitle2",fontWeight:800,border:c=>`1px solid ${Y(c.palette.primary.main,.16)}`,mx:"auto",transition:c=>c.transitions.create(["all"],{duration:c.transitions.duration.shorter}),"&:hover":{bgcolor:"primary.main",color:"primary.contrastText",transform:"scale(1.1)"}},children:w+1})}),e.jsx(j,{children:s.employee_name||"-"}),e.jsx(j,{children:s.subject||"-"}),e.jsx(j,{children:e.jsx(Z,{color:s.workflow_state==="Approved"&&"success"||s.workflow_state==="Rejected"&&"error"||"warning",children:s.workflow_state||"Pending"})}),e.jsx(j,{children:s.creation?new Date(s.creation).toLocaleDateString():"-"}),e.jsx(j,{align:"right",children:e.jsxs(l,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[e.jsx(R,{size:"small",color:"primary",onClick:i,children:e.jsx(p,{icon:"solar:eye-bold"})}),x&&e.jsx(R,{size:"small",color:"info",onClick:n,children:e.jsx(p,{icon:"solar:pen-bold"})}),y&&e.jsx(R,{size:"small",color:"error",onClick:m,children:e.jsx(p,{icon:"solar:trash-bin-trash-bold"})})]})})]})}function at({open:s,onClose:o,request:a}){const i=n=>e.jsx(Z,{variant:"soft",color:n==="Approved"&&"success"||n==="Rejected"&&"error"||"warning",children:n||"Pending"});return e.jsxs(te,{open:s,onClose:o,fullWidth:!0,maxWidth:"md",children:[e.jsxs(ae,{sx:{m:0,p:2.5,display:"flex",justifyContent:"space-between",alignItems:"center",bgcolor:"background.neutral"},children:[e.jsx(h,{variant:"h6",sx:{fontWeight:800},children:"Request Details"}),e.jsx(R,{onClick:o,sx:{color:n=>n.palette.grey[500],bgcolor:"background.paper",boxShadow:n=>{var m;return(m=n.customShadows)==null?void 0:m.z1}},children:e.jsx(p,{icon:"mingcute:close-line"})})]}),e.jsx(se,{sx:{p:4,m:2,mt:4},children:a?e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:5},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"flex-start",gap:2.5},children:[e.jsx(l,{sx:{width:80,height:80,borderRadius:2,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"primary.lighter",color:"primary.main"},children:e.jsx(p,{icon:"solar:document-text-bold",width:40})}),e.jsxs(l,{sx:{flexGrow:1},children:[e.jsx(h,{variant:"h5",sx:{fontWeight:800},children:a.subject}),e.jsxs(h,{variant:"body2",sx:{color:"text.secondary",fontWeight:600},children:["Submitted by ",a.employee_name]})]}),e.jsxs(l,{sx:{textAlign:"right"},children:[i(a.workflow_state),e.jsxs(h,{variant:"caption",sx:{display:"block",mt:1,color:"text.disabled",fontWeight:700},children:["ID: ",a.name]})]})]}),e.jsx(ke,{sx:{borderStyle:"dashed"}}),e.jsxs(l,{children:[e.jsx(L,{title:"Request Information",icon:"solar:document-bold"}),e.jsxs(l,{sx:{display:"grid",gap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)"}},children:[e.jsx(C,{label:"Employee",value:a.employee_name,icon:"solar:user-bold"}),e.jsx(C,{label:"Subject",value:a.subject,icon:"solar:document-text-bold"})]})]}),e.jsxs(l,{children:[e.jsx(L,{title:"Message",icon:"solar:chat-line-bold"}),e.jsx(l,{sx:{p:3,bgcolor:"background.neutral",borderRadius:2},children:e.jsx(h,{variant:"body2",sx:{fontWeight:500,"& p":{margin:0,marginBottom:1},"& p:last-child":{marginBottom:0}},dangerouslySetInnerHTML:{__html:a.message||"-"}})})]}),e.jsxs(l,{sx:{p:3,bgcolor:"background.neutral",borderRadius:2},children:[e.jsx(L,{title:"Status & Approval",icon:"solar:check-circle-bold",noMargin:!0}),e.jsxs(l,{sx:{mt:3,display:"grid",gap:3,gridTemplateColumns:{xs:"1fr",sm:"1fr 1fr"}},children:[e.jsx(C,{label:"Status",value:a.workflow_state||"Pending",icon:"solar:flag-bold"}),a.approved_by&&e.jsx(C,{label:"Approved By",value:a.approved_by,icon:"solar:user-check-bold"}),e.jsx(C,{label:"Created On",value:a.creation?new Date(a.creation).toLocaleString():"-",icon:"solar:calendar-bold"})]})]})]}):e.jsxs(l,{sx:{py:10,textAlign:"center"},children:[e.jsx(p,{icon:"solar:ghost-bold",width:64,sx:{color:"text.disabled",mb:2}}),e.jsx(h,{variant:"h6",sx:{color:"text.secondary"},children:"No Request Found"})]})})]})}function L({title:s,icon:o,noMargin:a=!1}){return e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:a?0:2.5},children:[e.jsx(p,{icon:o,width:20,sx:{color:"primary.main"}}),e.jsx(h,{variant:"subtitle1",sx:{fontWeight:800,textTransform:"uppercase",letterSpacing:.5},children:s})]})}function C({label:s,value:o,icon:a}){return e.jsxs(l,{children:[e.jsx(h,{variant:"caption",sx:{color:"text.disabled",fontWeight:700,textTransform:"uppercase",mb:.5,display:"block"},children:s}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(p,{icon:a,width:16,sx:{color:"text.disabled"}}),e.jsx(h,{variant:"body2",sx:{fontWeight:700},children:o||"-"})]})]})}function rt(){const[s,o]=r.useState(0),[a,i]=r.useState(10),[n,m]=r.useState(""),[x,y]=r.useState("desc"),[b,w]=r.useState("creation"),[c,f]=r.useState([]),{data:u,total:re,refetch:_}=tt(s+1,a,n,b,x),[oe,T]=r.useState(!1),[P,E]=r.useState(!1),[M,I]=r.useState(null),[O,F]=r.useState({open:!1,id:null}),[H,v]=r.useState(""),[J,k]=r.useState(""),[U,q]=r.useState(""),[ne,V]=r.useState(!1),[le,ie]=r.useState(null),[ce,de]=r.useState([]),[N,ue]=r.useState({read:!1,write:!1,delete:!1}),[D,g]=r.useState({open:!1,message:"",severity:"success"});r.useState(()=>{et().then(ue)}),r.useState(()=>{Pe({page:1,page_size:1e3,search:""}).then(t=>{de(t.data||[])})});const me=t=>{y(b===t&&x==="asc"?"desc":"asc"),w(t)},he=t=>{f(t?u.map(d=>d.name):[])},pe=t=>{f(d=>d.includes(t)?d.filter(A=>A!==t):[...d,t])},xe=async()=>{try{await Promise.all(c.map(t=>X(t))),g({open:!0,message:`${c.length} request(s) deleted successfully`,severity:"success"}),f([]),_()}catch(t){g({open:!0,message:t.message||"Failed to delete requests",severity:"error"})}},fe=()=>{E(!1),I(null),v(""),k(""),q(""),T(!0)},W=()=>{T(!1),E(!1),I(null),v(""),k(""),q("")},ge=r.useCallback(t=>{I(t),v(t.employee_id||""),k(t.subject||""),q(t.message||""),E(!0),T(!0)},[]),je=r.useCallback(t=>{ie(t),V(!0)},[]),ye=r.useCallback(t=>{F({open:!0,id:t})},[]),be=async()=>{if(O.id)try{await X(O.id),g({open:!0,message:"Request deleted successfully",severity:"success"}),_()}catch(t){g({open:!0,message:t.message||"Failed to delete request",severity:"error"})}finally{F({open:!1,id:null})}},we=async t=>{t.preventDefault();const d={employee_id:H.trim(),subject:J.trim(),message:U.trim()};try{P&&M?(await Ze(M.name,d),g({open:!0,message:"Request updated successfully",severity:"success"})):(await Xe(d),g({open:!0,message:"Request created successfully",severity:"success"})),W(),_()}catch(A){g({open:!0,message:A.message||"Operation failed",severity:"error"})}},Se=(t,d)=>{o(d)},Ce=t=>{i(parseInt(t.target.value,10)),o(0)},Re=t=>{m(t.target.value),o(0)},G=()=>{g({...D,open:!1})},ve=!u.length&&!!n,Q=!u.length&&!n;return e.jsxs(Ee,{children:[e.jsxs(l,{sx:{mb:5,display:"flex",alignItems:"center"},children:[e.jsx(h,{variant:"h4",sx:{flexGrow:1},children:"Request List"}),N.write&&e.jsx(B,{variant:"contained",startIcon:e.jsx(p,{icon:"mingcute:add-line"}),onClick:fe,sx:{bgcolor:"#08a3cd",color:"common.white","&:hover":{bgcolor:"#068fb3"}},children:"New Request"})]}),e.jsxs(Ie,{children:[e.jsx(Ne,{numSelected:c.length,filterName:n,onFilterName:Re,searchPlaceholder:"Search requests...",onDelete:c.length>0?xe:void 0}),e.jsx(qe,{children:e.jsx(Le,{sx:{overflow:"unset"},children:e.jsxs($e,{sx:{minWidth:800},children:[e.jsx(We,{order:x,orderBy:b,rowCount:u.length,numSelected:c.length,onSort:me,onSelectAllRows:t=>he(t),hideCheckbox:!0,showIndex:!0,headLabel:[{id:"employee_name",label:"Employee Name"},{id:"subject",label:"Subject"},{id:"workflow_state",label:"Status"},{id:"creation",label:"Created On"},{id:"",label:""}]}),e.jsxs(ze,{children:[u.map((t,d)=>e.jsx(st,{index:s*a+d,hideCheckbox:!0,row:{id:t.name,employee_name:t.employee_name,subject:t.subject,workflow_state:t.workflow_state,creation:t.creation},selected:c.includes(t.name),onSelectRow:()=>pe(t.name),onView:()=>je(t),onEdit:()=>ge(t),onDelete:()=>ye(t.name),canEdit:N.write,canDelete:N.delete},t.name)),ve&&e.jsx(Ae,{searchQuery:n}),Q&&e.jsx(ee,{children:e.jsx(j,{colSpan:5,children:e.jsx(Oe,{title:"No requests found",description:"You haven't submitted any requests yet.",icon:"solar:document-text-bold-duotone"})})}),!Q&&e.jsx(Be,{height:68,emptyRows:Math.max(0,a-u.length)})]})]})})}),e.jsx(He,{component:"div",page:s,count:re,rowsPerPage:a,onPageChange:Se,rowsPerPageOptions:[5,10,25],onRowsPerPageChange:Ce})]}),e.jsx(te,{open:oe,onClose:W,fullWidth:!0,maxWidth:"sm",children:e.jsxs("form",{onSubmit:we,children:[e.jsxs(ae,{sx:{m:0,p:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[P?"Edit Request":"New Request",e.jsx(R,{onClick:W,children:e.jsx(p,{icon:"mingcute:close-line"})})]}),e.jsx(se,{dividers:!0,children:e.jsxs(l,{sx:{display:"grid",gap:3,margin:"1rem"},children:[e.jsxs(Je,{fullWidth:!0,required:!0,children:[e.jsx(Ue,{children:"Employee"}),e.jsx(Ve,{value:H,onChange:t=>v(t.target.value),label:"Employee",children:ce.map(t=>e.jsxs(De,{value:t.name,children:[t.employee_name," (",t.employee_id,")"]},t.name))})]}),e.jsx(K,{fullWidth:!0,label:"Subject",value:J,onChange:t=>k(t.target.value),required:!0,placeholder:"Enter request subject"}),e.jsx(K,{fullWidth:!0,label:"Message",value:U,onChange:t=>q(t.target.value),multiline:!0,rows:4,placeholder:"Enter request details"})]})}),e.jsx(Ge,{children:e.jsx(B,{type:"submit",variant:"contained",children:P?"Update":"Create"})})]})}),e.jsx(at,{open:ne,onClose:()=>V(!1),request:le}),e.jsx(Qe,{open:D.open,autoHideDuration:6e3,onClose:G,anchorOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(_e,{onClose:G,severity:D.severity,sx:{width:"100%"},children:D.message})}),e.jsx(Fe,{open:O.open,onClose:()=>F({open:!1,id:null}),title:"Confirm Delete",content:"Are you sure you want to delete this request?",action:e.jsx(B,{onClick:be,color:"error",variant:"contained",sx:{borderRadius:1.5,minWidth:100},children:"Delete"})})]})}function Tt(){return e.jsxs(e.Fragment,{children:[e.jsx("title",{children:`Requests - ${Te.appName}`}),e.jsx(rt,{})]})}export{Tt as default};

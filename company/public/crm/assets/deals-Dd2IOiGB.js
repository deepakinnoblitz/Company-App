import{f as I,H as R,r as o,j as e,B as p,d as We,v as N,I as v,T as m,p as L,D as lt,y as ot,S as Ee,w as nt}from"./index-Co7v2xsC.js";import{C as rt}from"./config-global-BX9xwJzv.js";import{d as it}from"./dayjs.min-C2542nnJ.js";import{h as je}from"./api-error-handler-CV6pRVHb.js";import{g as ct}from"./error-handler-Bmy_4JQL.js";import{D as dt,C as ut}from"./Card-CDV3jV6O.js";import{E as pt}from"./empty-content-BBDmaj4d.js";import{C as ht}from"./confirm-dialog--19ddTk_.js";import{L as be}from"./label-BpZ9ieER.js";import"./styles-wAmuuHpw.js";import{c as Le,d as D,T as xt,a as mt,e as gt}from"./TableRow-DqeBPnxy.js";import{C as ft}from"./Checkbox-CoJXcvzD.js";import{U as bt,a as jt,T as Ie,b as yt}from"./user-table-toolbar-BXgkag6p.js";import{D as Re,a as Be}from"./DialogContent-DtP-sWqR.js";import{D as Me}from"./DialogTitle-C3eBZids.js";import{S as W}from"./Stack-GQIY7Xk9.js";import{T as y}from"./TextField-BmVWmDzd.js";import{A as X}from"./Autocomplete-BIV6h0T7.js";import{B as vt}from"./Badge-DIppMJwA.js";import{L as St,A as Ct}from"./AdapterDayjs-BPhbSeWE.js";import{D as wt}from"./DatePicker-BMZY9CMK.js";import{D as Dt}from"./DialogActions-h_2rRG3x.js";import{T as _t}from"./TablePagination-CEaYVDlQ.js";import{S as kt}from"./Snackbar-BVA3LOhi.js";import"./useFormControl-Cqn8lfES.js";import"./Select-B1EkSlUY.js";import"./Popper-DDlcgFVJ.js";import"./usePreviousProps-CVIlMhUg.js";import"./Chip-Rg4Dn3a5.js";import"./index-Chjiymov.js";import"./useThemeProps-BDg4jra0.js";import"./visuallyHidden-Dan1xhjv.js";import"./KeyboardArrowRight-CBVMFcL2.js";import"./LastPage-CUGiC0iB.js";async function Tt(l){const d=await R(),n=await I("/api/method/company.company.doctype.deal.deal.get_deals_list",{method:"POST",headers:d,body:JSON.stringify({start:(l.page-1)*l.page_size,page_length:l.page_size,search:l.search,stage:l.stage,sort_by:l.sort_by,filterValues:l.filterValues})});if(!n.ok)throw new Error("Failed to fetch deals");const i=await n.json();return{data:i.message.data||[],total:i.message.total||0}}async function Ft(l){const d=await R(),n=await I("/api/method/frappe.client.insert",{method:"POST",headers:d,body:JSON.stringify({doc:{doctype:"Deal",...l}})}),i=await n.json();if(!n.ok)throw new Error(je(i,"Failed to create deal"));return i.message}async function Pt(l,d){const n=await R(),i=await I("/api/method/frappe.client.set_value",{method:"POST",headers:n,body:JSON.stringify({doctype:"Deal",name:l,fieldname:d})}),r=await i.json();if(!i.ok)throw new Error(je(r,"Failed to update deal"));return r.message}async function Ae(l){const d=await R(),n=await I("/api/method/frappe.client.delete",{method:"POST",headers:d,body:JSON.stringify({doctype:"Deal",name:l})}),i=await n.json();if(!n.ok)throw new Error(je(i,"Failed to delete deal"));return i.message}async function Nt(){const l=await I("/api/method/company.company.frontend_api.get_deal_permissions");return l.ok?(await l.json()).message||{read:!1,write:!1,delete:!1}:{read:!1,write:!1,delete:!1}}async function Ot(l){const d=await R(),n=await I("/api/method/company.company.doctype.deal.deal.get_deal_details",{method:"POST",headers:d,body:JSON.stringify({name:l})});if(!n.ok)throw new Error("Failed to fetch deal details");return(await n.json()).message}function Wt(l,d,n,i,r,b){const[w,j]=o.useState([]),[g,S]=o.useState(0),[u,c]=o.useState(!0),[O,A]=o.useState(0),f=()=>A(a=>a+1);return o.useEffect(()=>{c(!0),Tt({page:l+1,page_size:d,search:n,stage:i,sort_by:r,filterValues:b}).then(a=>{if(a&&typeof a=="object"&&"data"in a)j(a.data),S(a.total||0);else if(Array.isArray(a)){const x=a;j(x),S(x.length)}}).catch(a=>{console.error("Failed to fetch deals",a),j([]),S(0)}).finally(()=>c(!1))},[l,d,n,i,O,r,b]),{data:w,total:g,loading:u,refetch:f}}function It({row:l,selected:d,onEdit:n,onView:i,onDelete:r,onSelectRow:b,canEdit:w=!0,canDelete:j=!0,hideCheckbox:g=!1,index:S}){const u=c=>{switch(c){case"Closed Won":return"success";case"Closed Lost":return"error";case"Proposal Sent":case"Negotiation":return"warning";default:return"info"}};return e.jsxs(Le,{hover:!0,tabIndex:-1,role:"checkbox",selected:d,children:[!g&&e.jsx(D,{padding:"checkbox",children:e.jsx(ft,{disableRipple:!0,checked:d,onChange:b})}),typeof S=="number"&&e.jsx(D,{align:"center",children:e.jsx(p,{sx:{width:28,height:28,display:"flex",borderRadius:"50%",alignItems:"center",justifyContent:"center",bgcolor:c=>We(c.palette.primary.main,.08),color:"primary.main",typography:"subtitle2",fontWeight:800,border:c=>`1px solid ${We(c.palette.primary.main,.16)}`,mx:"auto",transition:c=>c.transitions.create(["all"],{duration:c.transitions.duration.shorter}),"&:hover":{bgcolor:"primary.main",color:"primary.contrastText",transform:"scale(1.1)"}},children:S+1})}),e.jsx(D,{component:"th",scope:"row",children:e.jsx(p,{sx:{gap:2,display:"flex",alignItems:"center"},children:l.title})}),e.jsx(D,{children:l.account}),e.jsx(D,{children:l.contactName?`${l.contactName} (${l.contact})`:l.contact}),e.jsx(D,{children:l.value?new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(l.value):"-"}),e.jsx(D,{children:e.jsx(be,{color:u(l.stage),children:l.stage})}),e.jsx(D,{children:l.expectedCloseDate||"-"}),e.jsx(D,{align:"right",children:e.jsxs(p,{sx:{display:"flex",justifyContent:"flex-end"},children:[w&&e.jsx(N,{onClick:n,sx:{color:"primary.main"},children:e.jsx(v,{icon:"solar:pen-bold"})}),j&&e.jsx(N,{onClick:r,sx:{color:"error.main"},children:e.jsx(v,{icon:"solar:trash-bin-trash-bold"})}),e.jsx(N,{onClick:i,sx:{color:"info.main"},children:e.jsx(v,{icon:"solar:eye-bold"})})]})})]})}function At({open:l,onClose:d,dealId:n,onEdit:i}){const[r,b]=o.useState(null),[w,j]=o.useState(!1);o.useEffect(()=>{l&&n?(j(!0),Ot(n).then(b).catch(u=>console.error("Failed to fetch deal details:",u)).finally(()=>j(!1))):b(null)},[l,n]);const g=u=>{let c="default";return u==="Qualification"&&(c="info"),(u==="Needs Analysis"||u==="Meeting Scheduled")&&(c="warning"),(u==="Proposal Sent"||u==="Negotiation")&&(c="primary"),u==="Closed Won"&&(c="success"),u==="Closed Lost"&&(c="error"),e.jsx(be,{variant:"soft",color:c,children:u})},S=u=>{let c="default";return u==="New Business"&&(c="success"),u==="Existing Business"&&(c="info"),e.jsx(be,{variant:"outlined",color:c,children:u})};return e.jsxs(Re,{open:l,onClose:d,fullWidth:!0,maxWidth:"md",children:[e.jsxs(Me,{sx:{m:0,p:2.5,display:"flex",justifyContent:"space-between",alignItems:"center",bgcolor:"background.neutral"},children:[e.jsx(m,{variant:"h6",sx:{fontWeight:800},children:"Deal Profile"}),e.jsx(p,{sx:{display:"flex",gap:1,alignItems:"center"},children:e.jsx(N,{onClick:d,sx:{color:u=>u.palette.grey[500],bgcolor:"background.paper",boxShadow:u=>{var c;return(c=u.customShadows)==null?void 0:c.z1}},children:e.jsx(v,{icon:"mingcute:close-line"})})})]}),e.jsx(Be,{sx:{p:4,m:2,mt:4},children:w?e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:10},children:e.jsx(v,{icon:"svg-spinners:12-dots-scale-rotate",width:40,sx:{color:"primary.main"}})}):r?e.jsxs(p,{sx:{display:"flex",flexDirection:"column",gap:5},children:[e.jsxs(p,{sx:{display:"flex",alignItems:"flex-start",gap:2.5},children:[e.jsx(p,{sx:{width:64,height:64,borderRadius:2,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"primary.lighter",color:"primary.main"},children:e.jsx(v,{icon:"solar:bag-bold",width:32})}),e.jsxs(p,{sx:{flexGrow:1},children:[e.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:2,mb:.5},children:[e.jsx(m,{variant:"h5",sx:{fontWeight:800},children:r.deal_title}),i&&n&&e.jsx(L,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(v,{icon:"solar:pen-bold",width:16}),onClick:()=>{i(n),d()},sx:{height:28,borderRadius:1,px:1.5,typography:"subtitle2",fontWeight:700,"&:hover":{boxShadow:u=>`0 0 0 2px ${u.palette.primary.lighter}`}},children:"Edit"})]}),e.jsx(m,{variant:"body2",sx:{color:"text.secondary",fontWeight:600},children:r.account})]}),e.jsxs(p,{sx:{textAlign:"right"},children:[g(r.stage),e.jsxs(m,{variant:"caption",sx:{display:"block",mt:1,color:"text.disabled",fontWeight:700},children:["ID: ",r.name]})]})]}),e.jsx(lt,{sx:{borderStyle:"dashed"}}),e.jsxs(p,{children:[e.jsx(fe,{title:"Deal Overview",icon:"solar:info-circle-bold"}),e.jsxs(p,{sx:{display:"grid",gap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)"}},children:[e.jsx(k,{label:"Value",value:r.value?`â‚¹${r.value.toLocaleString()}`:"-",icon:"solar:wad-of-money-bold",color:"success.main"}),e.jsx(k,{label:"Expected Close",value:r.expected_close_date,icon:"solar:calendar-bold"}),e.jsx(k,{label:"Probability",value:r.probability?`${r.probability}%`:"-",icon:"solar:chart-square-bold"}),e.jsxs(p,{children:[e.jsx(m,{variant:"caption",sx:{color:"text.disabled",fontWeight:700,textTransform:"uppercase",mb:1.5,display:"block"},children:"Deal Type"}),S(r.type||"New Business")]}),e.jsx(k,{label:"Contact",value:r.contact_name?`${r.contact_name} (${r.contact})`:r.contact,icon:"solar:user-bold"}),e.jsx(k,{label:"Source Lead",value:r.source_lead,icon:"solar:tag-horizontal-bold"})]})]}),e.jsxs(p,{children:[e.jsx(fe,{title:"Tracking & Next Steps",icon:"solar:walking-bold"}),e.jsxs(p,{sx:{display:"grid",gap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)"}},children:[e.jsx(k,{label:"Next Step",value:r.next_step,icon:"solar:flag-bold",color:"info.main"}),e.jsx(k,{label:"Owner",value:r.deal_owner||r.owner,icon:"solar:user-rounded-bold",color:"secondary.main"}),e.jsx(k,{label:"Creation",value:new Date(r.creation).toLocaleString(),icon:"solar:calendar-date-bold"})]})]}),e.jsxs(p,{sx:{p:3,bgcolor:"background.neutral",borderRadius:2},children:[e.jsx(fe,{title:"Notes & Remarks",icon:"solar:document-text-bold",noMargin:!0}),e.jsx(p,{sx:{mt:3,display:"flex",flexDirection:"column",gap:3},children:e.jsxs(p,{children:[e.jsx(m,{variant:"caption",sx:{color:"text.disabled",fontWeight:700,textTransform:"uppercase",mb:1,display:"block"},children:"Deal Notes"}),e.jsx(m,{variant:"body2",sx:{color:"text.primary",fontWeight:600,fontStyle:r.notes?"normal":"italic"},children:r.notes||"No notes added"})]})})]})]}):e.jsxs(p,{sx:{py:10,textAlign:"center"},children:[e.jsx(v,{icon:"solar:ghost-bold",width:64,sx:{color:"text.disabled",mb:2}}),e.jsx(m,{variant:"h6",sx:{color:"text.secondary"},children:"No Deal Found"})]})})]})}function fe({title:l,icon:d,noMargin:n=!1}){return e.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:1,mb:n?0:2.5},children:[e.jsx(v,{icon:d,width:20,sx:{color:"primary.main"}}),e.jsx(m,{variant:"subtitle1",sx:{fontWeight:800,textTransform:"uppercase",letterSpacing:.5},children:l})]})}function k({label:l,value:d,icon:n,color:i="text.primary"}){return e.jsxs(p,{children:[e.jsx(m,{variant:"caption",sx:{color:"text.disabled",fontWeight:700,textTransform:"uppercase",mb:.5,display:"block"},children:l}),e.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(v,{icon:n,width:16,sx:{color:"text.disabled"}}),e.jsx(m,{variant:"body2",sx:{fontWeight:700,color:i},children:d||"-"})]})]})}const Et=["Existing Business","New Business"],Lt=["Qualification","Needs Analysis","Meeting Scheduled","Proposal Sent","Negotiation","Closed Won","Closed Lost"];function Rt({open:l,onOpen:d,onClose:n,filters:i,onFilters:r,canReset:b,onResetFilters:w,options:j}){const g=(a,x)=>{r({[a]:x})},S=e.jsxs(p,{sx:{py:2.5,pl:3,pr:2,display:"flex",alignItems:"center",borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(m,{variant:"h6",sx:{flexGrow:1,fontWeight:600},children:"Filters"}),e.jsx(N,{onClick:w,disabled:!b,sx:{mr:.5,color:b?"primary.main":"text.disabled","&:hover":{bgcolor:b?"primary.lighter":"transparent"}},children:e.jsx(vt,{color:"error",variant:"dot",invisible:!b,children:e.jsx(v,{icon:"solar:restart-bold",width:20})})}),e.jsx(N,{onClick:n,sx:{color:"text.secondary","&:hover":{bgcolor:"action.hover"}},children:e.jsx(v,{icon:"mingcute:close-line",width:20})})]}),u=e.jsxs(W,{spacing:1.5,children:[e.jsx(m,{variant:"subtitle2",sx:{color:"text.primary",fontWeight:600},children:"Deal Type"}),e.jsxs(y,{select:!0,fullWidth:!0,value:i.type,onChange:a=>g("type",a.target.value),SelectProps:{native:!0},size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:1.5,bgcolor:"background.neutral","&:hover":{bgcolor:"action.hover"}}},children:[e.jsx("option",{value:"all",children:"All Types"}),Et.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),c=e.jsxs(W,{spacing:1.5,children:[e.jsx(m,{variant:"subtitle2",sx:{color:"text.primary",fontWeight:600},children:"Contact"}),e.jsx(X,{fullWidth:!0,size:"small",value:i.contact==="all"?null:j.contacts.find(a=>a.name===i.contact)||null,onChange:(a,x)=>{g("contact",x?x.name:"all")},options:j.contacts,getOptionLabel:a=>`${a.first_name} (${a.name})`,renderInput:a=>e.jsx(y,{...a,placeholder:"Search contacts...",sx:{"& .MuiOutlinedInput-root":{borderRadius:1.5,bgcolor:"background.neutral","&:hover":{bgcolor:"action.hover"}}}}),renderOption:(a,x)=>o.createElement("li",{...a,key:x.name},e.jsxs(m,{variant:"body2",sx:{fontSize:"13px"},children:[x.first_name," (",x.name,")"]}))})]}),O=e.jsxs(W,{spacing:1.5,children:[e.jsx(m,{variant:"subtitle2",sx:{color:"text.primary",fontWeight:600},children:"Account"}),e.jsx(X,{fullWidth:!0,size:"small",value:i.account==="all"?null:j.accounts.find(a=>a.name===i.account)||null,onChange:(a,x)=>{g("account",x?x.name:"all")},options:j.accounts,getOptionLabel:a=>`${a.account_name} (${a.name})`,renderInput:a=>e.jsx(y,{...a,placeholder:"Search accounts...",sx:{"& .MuiOutlinedInput-root":{borderRadius:1.5,bgcolor:"background.neutral","&:hover":{bgcolor:"action.hover"}}}}),renderOption:(a,x)=>o.createElement("li",{...a,key:x.name},e.jsxs(m,{variant:"body2",sx:{fontSize:"13px"},children:[x.account_name," (",x.name,")"]}))})]}),A=e.jsxs(W,{spacing:1.5,children:[e.jsx(m,{variant:"subtitle2",sx:{color:"text.primary",fontWeight:600},children:"Source Lead"}),e.jsxs(y,{select:!0,fullWidth:!0,value:i.source_lead,onChange:a=>g("source_lead",a.target.value),SelectProps:{native:!0},size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:1.5,bgcolor:"background.neutral","&:hover":{bgcolor:"action.hover"}}},children:[e.jsx("option",{value:"all",children:"All Sources"}),j.source_leads.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),f=e.jsxs(W,{spacing:1.5,children:[e.jsx(m,{variant:"subtitle2",sx:{color:"text.primary",fontWeight:600},children:"Stage"}),e.jsxs(y,{select:!0,fullWidth:!0,value:i.stage,onChange:a=>g("stage",a.target.value),SelectProps:{native:!0},size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:1.5,bgcolor:"background.neutral","&:hover":{bgcolor:"action.hover"}}},children:[e.jsx("option",{value:"all",children:"All Stages"}),Lt.map(a=>e.jsx("option",{value:a,children:a},a))]})]});return e.jsxs(ot,{anchor:"right",open:l,onClose:n,slotProps:{paper:{sx:{width:340,boxShadow:a=>a.customShadows.z24}}},sx:{zIndex:a=>a.zIndex.drawer+100},children:[S,e.jsx(Ee,{children:e.jsxs(W,{spacing:3,sx:{p:3},children:[u,c,O,A,f]})}),e.jsx(p,{sx:{p:2.5,borderTop:"1px solid",borderColor:"divider",bgcolor:"background.neutral"},children:e.jsx(L,{fullWidth:!0,size:"large",color:"inherit",variant:"outlined",startIcon:e.jsx(v,{icon:"solar:trash-bin-trash-bold"}),onClick:w,disabled:!b,sx:{borderRadius:1.5,borderColor:"divider",fontWeight:600,"&:hover":{borderColor:"error.main",color:"error.main",bgcolor:"error.lighter"},"&.Mui-disabled":{borderColor:"divider"}},children:"Clear All Filters"})})]})}function Bt(){const[l,d]=o.useState(0),[n,i]=o.useState(5),[r,b]=o.useState(""),[w,j]=o.useState("all"),[g,S]=o.useState({type:"all",contact:"all",account:"all",source_lead:"all",stage:"all"}),[u,c]=o.useState(!1),[O,A]=o.useState("modified_desc"),[f,a]=o.useState([]),[x,ee]=o.useState(!1),[ye,ve]=o.useState(!1),[T,B]=o.useState(null),[C,te]=o.useState(!1),[$e,Se]=o.useState(!1),[ae,M]=o.useState(""),[se,$]=o.useState(""),[Ce,z]=o.useState(""),[le,Q]=o.useState(""),[oe,G]=o.useState(null),[ne,H]=o.useState("Qualification"),[re,U]=o.useState(""),[we,q]=o.useState("New Business"),[De,Z]=o.useState(""),[_e,J]=o.useState(""),[ke,Y]=o.useState(""),[ie,ze]=o.useState([]),[ce,Qe]=o.useState([]),[de,ue]=o.useState({open:!1,id:null}),[pe,_]=o.useState({open:!1,message:"",severity:"success"}),[he,Ge]=o.useState({read:!0,write:!0,delete:!0}),[V,F]=o.useState({}),{data:P,total:Te,loading:E,refetch:xe}=Wt(l,n,r,w,O,g),He=t=>{S(s=>({...s,...t})),d(0)},Ue=()=>{S({type:"all",contact:"all",account:"all",source_lead:"all",stage:"all"}),d(0)},K=g.type!=="all"||g.contact!=="all"||g.account!=="all"||g.source_lead!=="all"||g.stage!=="all",Fe=["Advertisement","Cold Call","Employee Referral","External Referral","Online Store","Website","Social Media","Email Campaign","Walk In","Trade Show / Event","Partner","Distributor","Telemarketing","Existing Customer","Repeat Customer","Direct Mail","Marketplace","Google Ads","Facebook / Instagram Ads","LinkedIn","WhatsApp","Customer Support","Inbound Call","Outbound Call","Other"];o.useEffect(()=>{Promise.all([fetch('/api/method/frappe.client.get_list?doctype=Accounts&fields=["name","account_name"]&limit_page_length=999',{credentials:"include"}),fetch('/api/method/frappe.client.get_list?doctype=Contacts&fields=["name","first_name"]&limit_page_length=999',{credentials:"include"})]).then(async([t,s])=>{const h=await t.json(),ge=await s.json();ze(h.message||[]),Qe(ge.message||[])}).catch(t=>console.error("Failed to fetch dropdown options",t)),Nt().then(Ge)},[]);const qe=()=>{te(!1),B(null),M(""),$(""),z(""),Q(""),G(null),H("Qualification"),U(""),q("New Business"),Z(""),J(""),Y(""),F({}),ee(!0)},me=()=>{ee(!1),B(null),te(!1),M(""),$(""),z(""),Q(""),G(null),H("Qualification"),U(""),q("New Business"),Z(""),J(""),Y(""),F({})},Pe=()=>{_(t=>({...t,open:!1}))},Ze=t=>{ue({open:!0,id:t})},Je=async()=>{if(de.id)try{await Ae(de.id),_({open:!0,message:"Deal deleted successfully",severity:"success"}),await xe()}catch(t){console.error(t),_({open:!0,message:"Failed to delete deal",severity:"error"})}finally{ue({open:!1,id:null})}},Ye=async()=>{try{await Promise.all(f.map(t=>Ae(t))),_({open:!0,message:`${f.length} deals deleted successfully`,severity:"success"}),a([]),await xe()}catch(t){_({open:!0,message:t.message||"Error during bulk delete",severity:"error"})}},Ve=(t,s)=>{if(t){a(s);return}a([])},Ke=t=>{const s=f.indexOf(t);let h=[];s===-1?h=h.concat(f,t):s===0?h=h.concat(f.slice(1)):s===f.length-1?h=h.concat(f.slice(0,-1)):s>0&&(h=h.concat(f.slice(0,s),f.slice(s+1))),a(h)},Xe=async()=>{const t={},s=[];if(ae||(t.dealTitle=!0,s.push("Deal Title")),se||(t.account=!0,s.push("Account")),le||(t.value=!0,s.push("Deal Value")),ne||(t.stage=!0,s.push("Stage")),Object.keys(t).length>0){F(t),_({open:!0,message:`Please fill in mandatory fields: ${s.join(", ")}`,severity:"error"});return}try{ve(!0);const h={deal_title:ae,account:se,contact:Ce,value:Number(le),expected_close_date:oe?oe.format("YYYY-MM-DD"):"",stage:ne,probability:re?Number(re):void 0,type:we,source_lead:De,next_step:_e,notes:ke};T?(await Pt(T,h),_({open:!0,message:"Deal updated successfully",severity:"success"})):(await Ft(h),_({open:!0,message:"Deal created successfully",severity:"success"})),await xe(),me()}catch(h){console.error(h);const ge=ct(h);_({open:!0,message:ge||(T?"Failed to update deal":"Failed to create deal"),severity:"error"})}finally{ve(!1)}},Ne=t=>{te(!1),B(t);const s=P.find(h=>h.name===t);s&&(M(s.deal_title||""),$(s.account||""),z(s.contact||""),Q(s.value||""),G(s.expected_close_date?it(s.expected_close_date):null),H(s.stage||"Qualification"),U(s.probability||""),q(s.type||"New Business"),Z(s.source_lead||""),J(s.next_step||""),Y(s.notes||"")),ee(!0)},et=t=>{B(t),Se(!0)},tt=(t,s)=>d(s),at=t=>{i(parseInt(t.target.value,10)),d(0)},st=!E&&P.length===0&&(!!r||w!=="all"||K),Oe=!E&&P.length===0&&!r&&w==="all"&&!K;return e.jsxs(e.Fragment,{children:[e.jsxs(Re,{open:x,onClose:me,fullWidth:!0,maxWidth:"md",children:[e.jsxs(Me,{sx:{m:0,p:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[C?"Deal Details":T?"Edit Deal":"New Deal",e.jsx(N,{"aria-label":"close",onClick:me,sx:{color:t=>t.palette.grey[500]},children:e.jsx(v,{icon:"mingcute:close-line"})})]}),e.jsx(Be,{dividers:!0,children:e.jsx(St,{dateAdapter:Ct,children:e.jsxs(p,{sx:{display:"grid",margin:"1rem",columnGap:2,rowGap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)"}},children:[e.jsx(y,{fullWidth:!0,label:"Deal Title",value:ae,onChange:t=>{M(t.target.value),t.target.value&&F(s=>({...s,dealTitle:!1}))},required:!0,error:!!V.dealTitle,slotProps:{input:{readOnly:C}}}),e.jsx(X,{fullWidth:!0,options:ie,value:ie.find(t=>t.name===se)||null,onChange:(t,s)=>{$((s==null?void 0:s.name)||""),s&&F(h=>({...h,account:!1}))},getOptionLabel:t=>`${t.account_name||t.name} (${t.name})`,disabled:C,slotProps:{paper:{sx:{bgcolor:"#F0F8FF","& .MuiAutocomplete-listbox":{bgcolor:"#F0F8FF"}}}},renderInput:t=>e.jsx(y,{...t,label:"Account",required:!0,error:!!V.account})}),e.jsx(X,{fullWidth:!0,options:ce,value:ce.find(t=>t.name===Ce)||null,onChange:(t,s)=>z((s==null?void 0:s.name)||""),getOptionLabel:t=>`${t.first_name||t.name} (${t.name})`,disabled:C,slotProps:{paper:{sx:{bgcolor:"#F0F8FF","& .MuiAutocomplete-listbox":{bgcolor:"#F0F8FF"}}}},renderInput:t=>e.jsx(y,{...t,label:"Contact"})}),e.jsx(y,{fullWidth:!0,label:"Deal Value",type:"number",value:le,onChange:t=>{Q(t.target.value),t.target.value&&F(s=>({...s,value:!1}))},required:!0,error:!!V.value,slotProps:{input:{readOnly:C}}}),e.jsx(wt,{label:"Expected Close Date",value:oe,onChange:t=>G(t),disabled:C,slotProps:{textField:{fullWidth:!0}}}),e.jsxs(y,{select:!0,fullWidth:!0,label:"Stage",value:ne,onChange:t=>{H(t.target.value),t.target.value&&F(s=>({...s,stage:!1}))},required:!0,error:!!V.stage,disabled:C,SelectProps:{native:!0},InputLabelProps:{shrink:!0},sx:{"& .MuiInputBase-input.Mui-disabled":{WebkitTextFillColor:"rgba(0, 0, 0, 0.87)"}},children:[e.jsx("option",{value:"Qualification",children:"Qualification"}),e.jsx("option",{value:"Needs Analysis",children:"Needs Analysis"}),e.jsx("option",{value:"Meeting Scheduled",children:"Meeting Scheduled"}),e.jsx("option",{value:"Proposal Sent",children:"Proposal Sent"}),e.jsx("option",{value:"Negotiation",children:"Negotiation"}),e.jsx("option",{value:"Closed Won",children:"Closed Won"}),e.jsx("option",{value:"Closed Lost",children:"Closed Lost"})]}),e.jsx(y,{fullWidth:!0,label:"Probability (%)",type:"number",value:re,onChange:t=>U(t.target.value),slotProps:{input:{readOnly:C}}}),e.jsxs(y,{select:!0,fullWidth:!0,label:"Type",value:we,onChange:t=>q(t.target.value),disabled:C,SelectProps:{native:!0},InputLabelProps:{shrink:!0},sx:{"& .MuiInputBase-input.Mui-disabled":{WebkitTextFillColor:"rgba(0, 0, 0, 0.87)"}},children:[e.jsx("option",{value:"New Business",children:"New Business"}),e.jsx("option",{value:"Existing Business",children:"Existing Business"})]}),e.jsxs(y,{select:!0,fullWidth:!0,label:"Source Lead",value:De,onChange:t=>Z(t.target.value),disabled:C,SelectProps:{native:!0},InputLabelProps:{shrink:!0},sx:{"& .MuiInputBase-input.Mui-disabled":{WebkitTextFillColor:"rgba(0, 0, 0, 0.87)"}},children:[e.jsx("option",{value:"",disabled:!0,children:"Select Source"}),Fe.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx(y,{fullWidth:!0,label:"Next Step",value:_e,onChange:t=>J(t.target.value),slotProps:{input:{readOnly:C}}}),e.jsx(y,{fullWidth:!0,label:"Notes",multiline:!0,rows:3,value:ke,onChange:t=>Y(t.target.value),sx:{gridColumn:{sm:"span 2"}},slotProps:{input:{readOnly:C}}})]})})}),e.jsx(Dt,{children:!C&&e.jsx(L,{variant:"contained",onClick:Xe,disabled:ye,children:ye?T?"Updating...":"Creating...":T?"Update Deal":"Create Deal"})})]}),e.jsxs(dt,{children:[e.jsxs(p,{sx:{mb:5,display:"flex",alignItems:"center"},children:[e.jsx(m,{variant:"h4",sx:{flexGrow:1},children:"Deals"}),he.write&&e.jsx(L,{variant:"contained",startIcon:e.jsx(v,{icon:"mingcute:add-line"}),onClick:qe,sx:{bgcolor:"#08a3cd",color:"common.white","&:hover":{bgcolor:"#068fb3"}},children:"New Deal"})]}),e.jsxs(ut,{children:[e.jsx(bt,{numSelected:f.length,filterName:r,onFilterName:t=>{b(t.target.value),d(0)},searchPlaceholder:"Search deals...",onOpenFilter:()=>c(!0),canReset:K,sortBy:O,onSortChange:A,onDelete:Ye,sortOptions:[{value:"modified_desc",label:"Newest First"},{value:"modified_asc",label:"Oldest First"},{value:"deal_title_asc",label:"Title: A to Z"},{value:"deal_title_desc",label:"Title: Z to A"},{value:"account_asc",label:"Account: A to Z"},{value:"account_desc",label:"Account: Z to A"},{value:"contact_name_asc",label:"Contact Name: A to Z"},{value:"contact_name_desc",label:"Contact Name: Z to A"},{value:"value_desc",label:"Deal Value: High to Low"},{value:"value_asc",label:"Deal Value: Low to High"}]}),e.jsx(Ee,{children:e.jsx(xt,{sx:{overflow:"unset"},children:e.jsxs(mt,{sx:{minWidth:800},children:[e.jsx(jt,{rowCount:Te,numSelected:f.length,onSelectAllRows:t=>Ve(t,P.map(s=>s.name)),hideCheckbox:!0,showIndex:!0,headLabel:[{id:"deal_title",label:"Title"},{id:"account",label:"Account"},{id:"contact",label:"Contact"},{id:"value",label:"Value"},{id:"stage",label:"Stage"},{id:"expected_close_date",label:"Expected Close"},{id:""}]}),e.jsxs(gt,{children:[E&&e.jsx(Ie,{height:68,emptyRows:n}),!E&&P.map((t,s)=>e.jsx(It,{index:l*n+s,hideCheckbox:!0,row:{id:t.name,title:t.deal_title??"-",account:t.account??"-",contact:t.contact??"-",contactName:t.contact_name??"",value:t.value??0,stage:t.stage??"-",expectedCloseDate:t.expected_close_date??"-",avatarUrl:"/assets/images/avatar/avatar-25.webp"},selected:f.includes(t.name),onSelectRow:()=>Ke(t.name),onEdit:()=>Ne(t.name),onDelete:()=>Ze(t.name),onView:()=>et(t.name),canEdit:he.write,canDelete:he.delete},t.name)),st&&e.jsx(yt,{searchQuery:r}),Oe&&e.jsx(Le,{children:e.jsx(D,{colSpan:10,align:"center",children:e.jsx(pt,{title:"No deals found",description:"Create a new deal to track your sales pipeline.",icon:"solar:hand-stars-bold-duotone"})})}),!Oe&&!E&&P.length<n&&e.jsx(Ie,{height:68,emptyRows:n-P.length})]})]})})}),e.jsx(_t,{component:"div",page:l,count:Te,rowsPerPage:n,onPageChange:tt,rowsPerPageOptions:[5,10,25],onRowsPerPageChange:at})]}),e.jsx(At,{open:$e,onClose:()=>{Se(!1)},dealId:T,onEdit:Ne})]}),e.jsx(Rt,{open:u,onOpen:()=>c(!0),onClose:()=>c(!1),filters:g,onFilters:He,canReset:K,onResetFilters:Ue,options:{contacts:ce,accounts:ie,source_leads:Fe}}),e.jsx(ht,{open:de.open,onClose:()=>ue({open:!1,id:null}),title:"Confirm Delete",content:"Are you sure you want to delete this deal?",action:e.jsx(L,{onClick:Je,color:"error",variant:"contained",sx:{borderRadius:1.5,minWidth:100},children:"Delete"})}),e.jsx(kt,{open:pe.open,autoHideDuration:6e3,onClose:Pe,anchorOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(nt,{onClose:Pe,severity:pe.severity,sx:{width:"100%"},children:pe.message})})]})}function ya(){return e.jsxs(e.Fragment,{children:[e.jsxs("title",{children:[" ",`Deals - ${rt.appName}`]}),e.jsx(Bt,{})]})}export{ya as default};

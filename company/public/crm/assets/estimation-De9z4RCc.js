import{r as l,j as e,T as n,v as V,I as u,B as o,D as le,p as O,S as ce,h as de,d as P}from"./index-Co7v2xsC.js";import{C as xe}from"./config-global-BX9xwJzv.js";import{d as he}from"./dayjs.min-C2542nnJ.js";import{r as me,u as L,w as pe}from"./reports-0l1D3gVE.js";import{D as ge,C as z}from"./Card-CDV3jV6O.js";import{E as ue}from"./export-fields-dialog-DKDJ10Kv.js";import{g as fe}from"./estimation-B3H7gbs5.js";import{L as je}from"./label-BpZ9ieER.js";import"./styles-wAmuuHpw.js";import{D as be,a as ye}from"./DialogContent-DtP-sWqR.js";import{D as ve}from"./DialogTitle-C3eBZids.js";import{S as R}from"./Stack-GQIY7Xk9.js";import{T as Se}from"./TextField-BmVWmDzd.js";import{L as we,A as Ce}from"./AdapterDayjs-BPhbSeWE.js";import{D as Q}from"./DatePicker-BMZY9CMK.js";import{T as _e,a as ke,b as De,c as $,d as a,e as Ee}from"./TableRow-DqeBPnxy.js";import{C as U}from"./Checkbox-CoJXcvzD.js";import{T as Te}from"./TablePagination-CEaYVDlQ.js";import"./api-error-handler-CV6pRVHb.js";import"./RadioGroup-B7r1ll7C.js";import"./useFormControl-Cqn8lfES.js";import"./FormControlLabel-CEvUm0a3.js";import"./DialogActions-h_2rRG3x.js";import"./Select-B1EkSlUY.js";import"./index-Chjiymov.js";import"./useThemeProps-BDg4jra0.js";import"./Popper-DDlcgFVJ.js";import"./visuallyHidden-Dan1xhjv.js";import"./Chip-Rg4Dn3a5.js";import"./KeyboardArrowRight-CBVMFcL2.js";import"./LastPage-CUGiC0iB.js";function Re({open:r,onClose:d,estimationId:f}){var j,m,E,S;const[s,p]=l.useState(null),[v,g]=l.useState(!1);return l.useEffect(()=>{r&&f?(g(!0),fe(f).then(p).catch(i=>console.error("Failed to fetch estimation details:",i)).finally(()=>g(!1))):p(null)},[r,f]),e.jsxs(be,{open:r,onClose:d,fullWidth:!0,maxWidth:"md",children:[e.jsxs(ve,{sx:{m:0,p:2.5,display:"flex",justifyContent:"space-between",alignItems:"center",bgcolor:"background.neutral"},children:[e.jsx(n,{variant:"h6",sx:{fontWeight:800},children:"Estimation Profile"}),e.jsx(V,{onClick:d,sx:{color:i=>i.palette.grey[500],bgcolor:"background.paper",boxShadow:i=>{var w;return(w=i.customShadows)==null?void 0:w.z1}},children:e.jsx(u,{icon:"mingcute:close-line"})})]}),e.jsx(ye,{sx:{p:4,m:2,mt:4},children:v?e.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:10},children:e.jsx(u,{icon:"svg-spinners:12-dots-scale-rotate",width:40,sx:{color:"primary.main"}})}):s?e.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:5},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:2.5},children:[e.jsx(o,{sx:{width:64,height:64,borderRadius:2,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"primary.lighter",color:"primary.main"},children:e.jsx(u,{icon:"solar:bill-list-bold-duotone",width:32})}),e.jsxs(o,{sx:{flexGrow:1},children:[e.jsx(n,{variant:"h5",sx:{fontWeight:800},children:s.customer_name}),e.jsxs(n,{variant:"body2",sx:{color:"text.secondary",fontWeight:600},children:["Ref No: ",s.ref_no||"-"]})]}),e.jsxs(o,{sx:{textAlign:"right"},children:[e.jsx(je,{variant:"soft",color:"info",children:"Estimation"}),e.jsxs(n,{variant:"caption",sx:{display:"block",mt:1,color:"text.disabled",fontWeight:700},children:["ID: ",s.name]})]})]}),e.jsx(le,{sx:{borderStyle:"dashed"}}),e.jsxs(o,{children:[e.jsx(A,{title:"Estimation Details",icon:"solar:info-circle-bold"}),e.jsxs(o,{sx:{display:"grid",gap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)"}},children:[e.jsx(y,{label:"Customer",value:s.customer_name,icon:"solar:user-bold"}),e.jsx(y,{label:"Ref No",value:s.ref_no,icon:"solar:tag-bold"}),e.jsx(y,{label:"Estimate Date",value:s.estimate_date,icon:"solar:calendar-date-bold"}),e.jsx(y,{label:"Billing Name",value:s.billing_name,icon:"solar:bill-list-bold"}),e.jsx(y,{label:"Phone Number",value:s.phone_number,icon:"solar:phone-bold"}),e.jsx(y,{label:"Grand Total",value:`₹${((j=s.grand_total)==null?void 0:j.toLocaleString())||0}`,icon:"solar:wad-of-money-bold",color:"primary.main"})]})]}),e.jsxs(o,{children:[e.jsx(A,{title:"Items",icon:"solar:cart-large-minimalistic-bold"}),e.jsxs(o,{sx:{bgcolor:"background.neutral",borderRadius:2,overflow:"hidden",border:i=>`1px solid ${i.palette.divider}`},children:[e.jsxs(o,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",p:1.5,bgcolor:i=>i.palette.grey[200],borderBottom:i=>`1px solid ${i.palette.divider}`},children:[e.jsx(n,{variant:"caption",sx:{fontWeight:800,color:"text.secondary"},children:"ITEM"}),e.jsx(n,{variant:"caption",sx:{fontWeight:800,color:"text.secondary",textAlign:"right"},children:"QTY"}),e.jsx(n,{variant:"caption",sx:{fontWeight:800,color:"text.secondary",textAlign:"right"},children:"PRICE"}),e.jsx(n,{variant:"caption",sx:{fontWeight:800,color:"text.secondary",textAlign:"right"},children:"TOTAL"})]}),e.jsxs(o,{sx:{display:"flex",flexDirection:"column"},children:[(m=s.table_qecz)==null?void 0:m.map((i,w)=>{var _,C;return e.jsxs(o,{sx:{display:"grid",gridTemplateColumns:"2fr 1fr 1fr 1fr",p:1.5,borderBottom:F=>w!==s.table_qecz.length-1?`1px solid ${F.palette.divider}`:"none"},children:[e.jsxs(o,{children:[e.jsx(n,{variant:"subtitle2",children:i.service}),e.jsx(n,{variant:"caption",sx:{color:"text.disabled"},children:i.description||i.service})]}),e.jsx(n,{variant:"body2",sx:{textAlign:"right"},children:i.quantity}),e.jsxs(n,{variant:"body2",sx:{textAlign:"right"},children:["₹",((_=i.price)==null?void 0:_.toLocaleString())||0]}),e.jsxs(n,{variant:"body2",sx:{textAlign:"right",fontWeight:600},children:["₹",((C=i.sub_total)==null?void 0:C.toLocaleString())||0]})]},w)}),(!s.table_qecz||s.table_qecz.length===0)&&e.jsx(o,{sx:{p:3,textAlign:"center"},children:e.jsx(n,{variant:"body2",sx:{color:"text.secondary"},children:"No items found"})})]})]})]}),e.jsxs(o,{sx:{p:3,bgcolor:"background.neutral",borderRadius:2},children:[e.jsx(A,{title:"Financial Summary",icon:"solar:bill-list-bold",noMargin:!0}),e.jsxs(o,{sx:{mt:3,display:"grid",gap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)"}},children:[e.jsx(y,{label:"Total Qty",value:s.total_qty,icon:"solar:box-bold"}),e.jsx(y,{label:"Total Amount",value:`₹${((E=s.total_amount)==null?void 0:E.toLocaleString())||0}`,icon:"solar:wad-of-money-bold"}),e.jsx(y,{label:"Grand Total",value:`₹${((S=s.grand_total)==null?void 0:S.toLocaleString())||0}`,icon:"solar:tag-bold",color:"primary.main"})]})]}),e.jsxs(o,{children:[e.jsx(A,{title:"System Information",icon:"solar:clock-circle-bold"}),e.jsxs(o,{sx:{display:"grid",gap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)"}},children:[e.jsx(y,{label:"Created On",value:new Date(s.creation).toLocaleString(),icon:"solar:calendar-date-bold"}),e.jsx(y,{label:"Owner",value:s.owner,icon:"solar:user-rounded-bold"})]})]})]}):e.jsxs(o,{sx:{py:10,textAlign:"center"},children:[e.jsx(u,{icon:"solar:ghost-bold",width:64,sx:{color:"text.disabled",mb:2}}),e.jsx(n,{variant:"h6",sx:{color:"text.secondary"},children:"Estimation Not Found"})]})})]})}function A({title:r,icon:d,noMargin:f=!1}){return e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,mb:f?0:2.5},children:[e.jsx(u,{icon:d,width:20,sx:{color:"primary.main"}}),e.jsx(n,{variant:"subtitle1",sx:{fontWeight:800,textTransform:"uppercase",letterSpacing:.5},children:r})]})}function y({label:r,value:d,icon:f,color:s="text.primary"}){return e.jsxs(o,{children:[e.jsx(n,{variant:"caption",sx:{color:"text.disabled",fontWeight:700,textTransform:"uppercase",mb:.5,display:"block"},children:r}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(u,{icon:f,width:16,sx:{color:"text.disabled"}}),e.jsx(n,{variant:"body2",sx:{fontWeight:700,color:s},children:d||"-"})]})]})}function Ie(){const[r,d]=l.useState([]),[f,s]=l.useState([]),[p,v]=l.useState(!1),[g,j]=l.useState(""),[m,E]=l.useState(null),[S,i]=l.useState(null),[w,_]=l.useState(0),[C,F]=l.useState(10),[J,q]=l.useState(!1),[K,B]=l.useState(null),[b,N]=l.useState([]),[X,M]=l.useState(!1),Z=t=>{if(t.target.checked){const x=r.map(h=>h.name);N(x);return}N([])},ee=(t,x)=>{const h=b.indexOf(x);let c=[];h===-1?c=c.concat(b,x):h===0?c=c.concat(b.slice(1)):h===b.length-1?c=c.concat(b.slice(0,-1)):h>0&&(c=c.concat(b.slice(0,h),b.slice(h+1))),N(c)},te=async(t,x)=>{v(!0);try{if(r.length===0){v(!1);return}const c=[];g&&c.push(["customer_name","like",`%${g}%`]),m&&c.push(["estimate_date",">=",m]),S&&c.push(["estimate_date","<=",S]);const k=t.length>0?t:["name","customer_name","estimate_date","total_qty","grand_total"];k.includes("name")||k.push("name");const I=new URLSearchParams({doctype:"Estimation",fields:JSON.stringify(k),filters:JSON.stringify(c),limit_page_length:"99999"}),T=await fetch(`/api/method/frappe.client.get_list?${I.toString()}`,{method:"GET",credentials:"include"});if(!T.ok)throw new Error("Failed to fetch data for export");const ae=(await T.json()).message||[],H=L.json_to_sheet(ae);if(x==="excel"){const W=L.book_new();L.book_append_sheet(W,H,"Estimations"),pe(W,"Estimation_Report.xlsx")}else{const W=L.sheet_to_csv(H),ne=new Blob([W],{type:"text/csv;charset=utf-8;"}),D=document.createElement("a"),ie=URL.createObjectURL(ne);D.setAttribute("href",ie),D.setAttribute("download","Estimation_Report.csv"),D.style.visibility="hidden",document.body.appendChild(D),D.click(),document.body.removeChild(D)}}catch(h){console.error(h)}finally{v(!1)}},oe=l.useCallback((t,x)=>{_(x)},[]),se=l.useCallback(t=>{F(parseInt(t.target.value,10)),_(0)},[]),Y=l.useCallback(async()=>{v(!0);try{const t={};g&&(t.client_name=g),m&&(t.from_date=m.format("YYYY-MM-DD")),S&&(t.to_date=S.format("YYYY-MM-DD")),console.log("Fetching Estimation Report with filters:",t);const x=await me("Estimation Report",t);d(x.result||[]),s(x.report_summary||[]),_(0)}catch(t){console.error("Failed to fetch estimation report:",t)}finally{v(!1)}},[g,m,S]);l.useEffect(()=>{Y()},[Y]);const re=()=>{j(""),E(null),i(null)};return e.jsxs(ge,{children:[e.jsxs(R,{spacing:3,children:[e.jsxs(R,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsx(n,{variant:"h4",children:"Estimation Report"}),e.jsxs(R,{direction:"row",spacing:1,children:[e.jsx(O,{variant:"outlined",startIcon:e.jsx(u,{icon:"solar:refresh-bold"}),onClick:Y,disabled:p,children:"Refresh"}),e.jsx(O,{variant:"outlined",color:"error",startIcon:e.jsx(u,{icon:"solar:restart-bold"}),onClick:re,children:"Reset"})]})]}),e.jsxs(z,{sx:{p:2.5,display:"flex",gap:2,flexWrap:"wrap",alignItems:"center",bgcolor:"background.neutral",border:t=>`1px solid ${t.palette.divider}`},children:[e.jsx(Se,{label:"Customer Name",value:g,onChange:t=>j(t.target.value),placeholder:"Search customer...",size:"small",sx:{minWidth:200}}),e.jsxs(we,{dateAdapter:Ce,children:[e.jsx(Q,{label:"From Date",value:m,onChange:t=>E(t),slotProps:{textField:{size:"small"}}}),e.jsx(Q,{label:"To Date",value:S,onChange:t=>i(t),slotProps:{textField:{size:"small"}}})]}),e.jsx(o,{sx:{flexGrow:1}}),e.jsx(O,{variant:"contained",startIcon:e.jsx(u,{icon:"solar:export-bold"}),onClick:()=>M(!0),children:"Export"})]}),e.jsx(o,{sx:{display:"grid",gap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)"}},children:f.map((t,x)=>e.jsx(We,{item:t},x))}),e.jsxs(z,{sx:{boxShadow:"0 0 2px 0 rgba(145, 158, 171, 0.2), 0 12px 24px -4px rgba(145, 158, 171, 0.12)"},children:[e.jsx(ce,{children:e.jsx(_e,{sx:{minWidth:900,maxHeight:440,overflowY:"auto"},children:e.jsxs(ke,{size:"medium",stickyHeader:!0,children:[e.jsx(De,{children:e.jsxs($,{sx:{bgcolor:"#f4f6f8"},children:[e.jsx(a,{padding:"checkbox",children:e.jsx(U,{indeterminate:b.length>0&&b.length<r.length,checked:r.length>0&&b.length===r.length,onChange:Z})}),e.jsx(a,{sx:{fontWeight:700,color:"text.secondary"},children:"Ref No"}),e.jsx(a,{sx:{fontWeight:700,color:"text.secondary"},children:"Customer"}),e.jsx(a,{sx:{fontWeight:700,color:"text.secondary"},children:"Date"}),e.jsx(a,{sx:{fontWeight:700,color:"text.secondary"},children:"Item"}),e.jsx(a,{align:"center",sx:{fontWeight:700,color:"text.secondary"},children:"Qty"}),e.jsx(a,{align:"right",sx:{fontWeight:700,color:"text.secondary"},children:"Price"}),e.jsx(a,{align:"right",sx:{fontWeight:700,color:"text.secondary"},children:"Tax"}),e.jsx(a,{align:"right",sx:{fontWeight:700,color:"text.secondary"},children:"Subtotal"}),e.jsx(a,{align:"right",sx:{fontWeight:700,color:"text.secondary"},children:"Grand Total"}),e.jsx(a,{align:"right",sx:{fontWeight:700,color:"text.secondary",position:"sticky",right:0,bgcolor:"#f4f6f8",zIndex:11},children:"Actions"})]})}),e.jsxs(Ee,{children:[r.slice(w*C,w*C+C).map((t,x)=>{var c,k,I,T;const h=b.indexOf(t.name)!==-1;return e.jsxs($,{hover:!0,role:"checkbox","aria-checked":h,selected:h,children:[e.jsx(a,{padding:"checkbox",children:e.jsx(U,{checked:h,onClick:G=>ee(G,t.name)})}),e.jsx(a,{children:t.name}),e.jsx(a,{children:t.customer_name}),e.jsx(a,{children:t.estimate_date?he(t.estimate_date).format("DD MMM YYYY"):"-"}),e.jsx(a,{sx:{maxWidth:200,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.service}),e.jsx(a,{align:"center",children:t.quantity}),e.jsxs(a,{align:"right",children:["₹",((c=t.price)==null?void 0:c.toLocaleString())||0]}),e.jsxs(a,{align:"right",children:["₹",((k=t.tax_amount)==null?void 0:k.toLocaleString())||0]}),e.jsxs(a,{align:"right",children:["₹",((I=t.sub_total)==null?void 0:I.toLocaleString())||0]}),e.jsxs(a,{align:"right",sx:{fontWeight:700},children:["₹",((T=t.grand_total)==null?void 0:T.toLocaleString())||0]}),e.jsx(a,{align:"right",sx:{position:"sticky",right:0,bgcolor:"background.paper",boxShadow:"-2px 0 4px rgba(145, 158, 171, 0.08)"},children:e.jsx(V,{onClick:()=>{B(t.name),q(!0)},sx:{color:"info.main"},children:e.jsx(u,{icon:"solar:eye-bold"})})})]},x)}),r.length===0&&!p&&e.jsx($,{children:e.jsx(a,{colSpan:11,align:"center",sx:{py:10},children:e.jsxs(R,{spacing:1,alignItems:"center",children:[e.jsx(u,{icon:"eva:slash-outline",width:48,sx:{color:"text.disabled"}}),e.jsx(n,{variant:"body2",sx:{color:"text.disabled"},children:"No data found"})]})})})]})]})})}),e.jsx(Te,{component:"div",count:r.length,page:w,onPageChange:oe,rowsPerPage:C,onRowsPerPageChange:se,rowsPerPageOptions:[5,10,25]})]})]}),e.jsx(Re,{open:J,estimationId:K,onClose:()=>{q(!1),B(null)}}),e.jsx(ue,{open:X,onClose:()=>M(!1),doctype:"Estimation",onExport:te})]})}function We({item:r}){var v,g;const d=de(),f=j=>{switch(j==null?void 0:j.toLowerCase()){case"blue":return d.palette.info.main;case"green":return d.palette.success.main;case"orange":return d.palette.warning.main;case"red":return d.palette.error.main;default:return d.palette.primary.main}},s=j=>{const m=j.toLowerCase();return m.includes("amount")?"solar:wad-of-money-bold-duotone":m.includes("quantity")?"solar:box-bold-duotone":m.includes("records")?"solar:document-text-bold-duotone":"solar:chart-2-bold-duotone"},p=f(r.indicator);return e.jsxs(z,{sx:{p:3,boxShadow:"none",position:"relative",overflow:"hidden",bgcolor:P(p,.04),border:`1px solid ${P(p,.1)}`,transition:d.transitions.create(["transform","box-shadow"]),"&:hover":{transform:"translateY(-4px)",boxShadow:`0 12px 24px -4px ${P(p,.12)}`}},children:[e.jsxs(R,{direction:"row",alignItems:"center",spacing:2.5,children:[e.jsx(o,{sx:{width:48,height:48,flexShrink:0,display:"flex",borderRadius:1.5,alignItems:"center",justifyContent:"center",color:p,bgcolor:P(p,.1)},children:e.jsx(u,{icon:s(r.label),width:28})}),e.jsxs(o,{sx:{flexGrow:1},children:[e.jsx(n,{variant:"subtitle2",sx:{color:"text.secondary",fontWeight:700,mb:.5},children:r.label}),e.jsx(n,{variant:"h4",sx:{color:"text.primary",fontWeight:800},children:r.datatype==="Currency"?`₹${(v=r.value)==null?void 0:v.toLocaleString()}`:(g=r.value)==null?void 0:g.toLocaleString()})]})]}),e.jsx(o,{sx:{top:-16,right:-16,width:80,height:80,opacity:.08,position:"absolute",borderRadius:"50%",bgcolor:p}})]})}function dt(){return e.jsxs(e.Fragment,{children:[e.jsx("title",{children:`Estimation Report - ${xe.appName}`}),e.jsx(Ie,{})]})}export{dt as default};

import{g as ee,a as se,r as t,u as ae,j as e,s as oe,c as re,b as te,i as ne,bc as b,ap as le,T as P,p as _,I as f,B as ie,A as de,v as S,w as L,f as F}from"./index-Co7v2xsC.js";import{C as ce}from"./config-global-BX9xwJzv.js";import{D as me,C as $}from"./Card-CDV3jV6O.js";import{S as p}from"./Stack-GQIY7Xk9.js";import{C as q}from"./CardHeader-CmhzWAj1.js";import{G as i}from"./Grid-BdmJn5bP.js";import{T as d}from"./TextField-BmVWmDzd.js";import{C as V}from"./Chip-Rg4Dn3a5.js";import{D as pe,a as ue}from"./DialogContent-DtP-sWqR.js";import{D as he}from"./DialogTitle-C3eBZids.js";import{I as T}from"./Select-B1EkSlUY.js";import{D as xe}from"./DialogActions-h_2rRG3x.js";import{S as ge}from"./Snackbar-BVA3LOhi.js";import"./useFormControl-Cqn8lfES.js";function fe(a){return ee("MuiCardContent",a)}se("MuiCardContent",["root"]);const je=a=>{const{classes:c}=a;return te({root:["root"]},fe,c)},ye=oe("div",{name:"MuiCardContent",slot:"Root",overridesResolver:(a,c)=>c.root})({padding:16,"&:last-child":{paddingBottom:24}}),K=t.forwardRef(function(c,u){const n=ae({props:c,name:"MuiCardContent"}),{className:j,component:m="div",...y}=n,h={...n,component:m},x=je(h);return e.jsx(ye,{as:m,className:re(x.root,j),ownerState:h,ref:u,...y})});function we(){const{user:a,setUser:c}=ne(),[u,n]=t.useState({open:!1,message:"",severity:"success"}),j=()=>{n(s=>({...s,open:!1}))},m=b(),[y,h]=t.useState(""),[x,D]=t.useState(""),[z,M]=t.useState(""),[R,N]=t.useState(!1),[E,g]=t.useState(""),I=b(),k=b(),A=b(),Q=async()=>{if(g(""),N(!1),x!==z){g("New passwords do not match");return}try{const o=await(await F("/api/method/company.company.frontend_api.update_my_password",{method:"POST",body:JSON.stringify({old_password:y,new_password:x})})).json();if(o.message&&o.message.status==="success")n({open:!0,message:"Password updated successfully",severity:"success"}),m.onFalse(),h(""),D(""),M(""),g("");else{let r="Failed to update password";if(o.exception)if(o.exception.includes("Incorrect old password"))N(!0),r="Incorrect old password";else{const l=o.exception.split(":");r=l.length>1?l.slice(1).join(":").trim():o.exception}else if(o._server_messages)try{const l=JSON.parse(o._server_messages);Array.isArray(l)&&l.length>0&&(r=JSON.parse(l[0]).message.replace(/<[^>]*>?/gm,""))}catch{}else o.message&&(typeof o.message=="object"&&o.message.status==="failed"?r=o.message.message:r=typeof o.message=="string"?o.message:JSON.stringify(o.message));g(r)}}catch(s){console.error(s);const o=s.message||"An error occurred";g(o)}},[w,U]=t.useState(""),[C,B]=t.useState(""),[v,J]=t.useState("");t.useEffect(()=>{a&&(U(a.first_name||""),B(a.middle_name||""),J(a.last_name||""))},[a]);const G=[w,C,v].filter(Boolean).join(" "),H=t.useRef(null),X=async s=>{var l;const o=(l=s.target.files)==null?void 0:l[0];if(!o)return;const r=new FormData;r.append("file",o),r.append("doctype","User"),r.append("docname",(a==null?void 0:a.email)||""),r.append("fieldname","user_image"),r.append("is_private","0"),r.append("folder","Home");try{const W=await(await F("/api/method/company.company.frontend_api.upload_profile_image",{method:"POST",body:r})).json();if(W.message&&W.message.status==="success"){if(n({open:!0,message:"Profile picture updated!",severity:"success"}),a){const Z={...a,user_image:W.message.file_url};c(Z)}}else n({open:!0,message:"Failed to upload image",severity:"error"})}catch(O){console.error(O),n({open:!0,message:"Error uploading image",severity:"error"})}},Y=async()=>{var s;try{const r=await(await F("/api/method/company.company.frontend_api.update_profile_info",{method:"POST",body:JSON.stringify({first_name:w,middle_name:C,last_name:v})})).json();r.message&&r.message.status==="success"?(n({open:!0,message:"Profile updated successfully",severity:"success"}),a&&c({...a,first_name:w,middle_name:C,last_name:v,full_name:G})):n({open:!0,message:((s=r.message)==null?void 0:s.message)||"Failed to update profile",severity:"error"})}catch(o){console.error(o),n({open:!0,message:"An error occurred while saving profile",severity:"error"})}};return a?e.jsxs(me,{children:[e.jsxs(le,{maxWidth:"lg",children:[e.jsx(p,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{mb:5},children:e.jsx(P,{variant:"h4",children:"My Profile"})}),e.jsxs(p,{spacing:3,sx:{maxWidth:800,mx:"auto"},children:[e.jsxs($,{children:[e.jsx(q,{title:"Basic Info",subheader:"Review your personal details",action:e.jsxs(p,{direction:"row",spacing:2,children:[e.jsx(_,{variant:"outlined",color:"inherit",onClick:m.onTrue,startIcon:e.jsx(f,{icon:"solar:shield-keyhole-bold-duotone"}),children:"Change Password"}),e.jsx(_,{variant:"contained",color:"primary",onClick:Y,children:"Save Changes"})]})}),e.jsxs(K,{children:[e.jsxs(p,{alignItems:"center",sx:{mb:5,position:"relative"},children:[e.jsx("input",{type:"file",ref:H,onChange:X,style:{display:"none"},accept:"image/*"}),e.jsxs(ie,{sx:{position:"relative"},children:[e.jsx(de,{alt:a.full_name,src:a.user_image,sx:{width:144,height:144,mb:3,border:s=>`solid 2px ${s.palette.background.default}`}}),e.jsx(S,{onClick:()=>{var s;return(s=H.current)==null?void 0:s.click()},sx:{position:"absolute",bottom:24,right:0,width:40,height:40,bgcolor:"common.white",boxShadow:s=>s.customShadows.z8,"&:hover":{bgcolor:"grey.200"}},children:e.jsx(f,{icon:"solar:pen-bold",color:"text.secondary",width:24})})]})]}),e.jsxs(i,{container:!0,spacing:3,children:[e.jsx(i,{size:{xs:12,sm:6},children:e.jsx(d,{fullWidth:!0,label:"First Name",value:w,onChange:s=>U(s.target.value)})}),e.jsx(i,{size:{xs:12,sm:6},children:e.jsx(d,{fullWidth:!0,label:"Middle Name",value:C,onChange:s=>B(s.target.value)})}),e.jsx(i,{size:{xs:12,sm:6},children:e.jsx(d,{fullWidth:!0,label:"Last Name",value:v,onChange:s=>J(s.target.value)})}),e.jsx(i,{size:{xs:12,sm:6},children:e.jsx(d,{fullWidth:!0,label:"Full Name",value:G,InputProps:{readOnly:!0},helperText:"Automatically generated"})}),e.jsx(i,{size:{xs:12,sm:6},children:e.jsx(d,{fullWidth:!0,label:"Username",value:a.username||"",InputProps:{readOnly:!0}})}),e.jsx(i,{size:{xs:12,sm:6},children:e.jsx(d,{fullWidth:!0,label:"Email",value:a.email||"",InputProps:{readOnly:!0}})})]})]})]}),e.jsxs($,{children:[e.jsx(q,{title:"Access & Permissions",subheader:"Roles and allowed modules"}),e.jsx(K,{children:e.jsxs(i,{container:!0,spacing:3,children:[e.jsxs(i,{size:{xs:12},children:[e.jsx(P,{variant:"subtitle2",sx:{mb:1,color:"text.secondary"},children:"Roles"}),e.jsx(p,{direction:"row",flexWrap:"wrap",gap:1,children:a.roles.map(s=>e.jsx(V,{label:s,size:"small",variant:"outlined"},s))})]}),e.jsxs(i,{size:{xs:12},children:[e.jsx(P,{variant:"subtitle2",sx:{mb:1,color:"text.secondary"},children:"Allowed Modules"}),e.jsx(p,{direction:"row",flexWrap:"wrap",gap:1,children:a.allowed_modules.length>0?a.allowed_modules.map(s=>e.jsx(V,{label:s,size:"small",color:"primary",variant:"filled"},s)):e.jsx(P,{variant:"body2",sx:{color:"text.secondary"},children:"No extra modules allowed"})})]})]})})]})]})]}),e.jsxs(pe,{open:m.value,onClose:m.onFalse,maxWidth:"sm",fullWidth:!0,children:[e.jsx(he,{children:"Change Password"}),e.jsx(ue,{children:e.jsxs(p,{spacing:2,sx:{mt:1},children:[E&&e.jsx(L,{severity:"error",sx:{mb:2},children:E}),e.jsx(d,{fullWidth:!0,label:"Current Password",type:I.value?"text":"password",value:y,error:R,helperText:R?"Incorrect old password":"",onChange:s=>{h(s.target.value),N(!1)},InputProps:{endAdornment:e.jsx(T,{position:"end",children:e.jsx(S,{onClick:I.onToggle,edge:"end",children:e.jsx(f,{icon:I.value?"solar:eye-bold":"solar:eye-closed-bold"})})})}}),e.jsx(d,{fullWidth:!0,label:"New Password",type:k.value?"text":"password",value:x,onChange:s=>D(s.target.value),InputProps:{endAdornment:e.jsx(T,{position:"end",children:e.jsx(S,{onClick:k.onToggle,edge:"end",children:e.jsx(f,{icon:k.value?"solar:eye-bold":"solar:eye-closed-bold"})})})}}),e.jsx(d,{fullWidth:!0,label:"Confirm New Password",type:A.value?"text":"password",value:z,onChange:s=>M(s.target.value),InputProps:{endAdornment:e.jsx(T,{position:"end",children:e.jsx(S,{onClick:A.onToggle,edge:"end",children:e.jsx(f,{icon:A.value?"solar:eye-bold":"solar:eye-closed-bold"})})})}})]})}),e.jsxs(xe,{children:[e.jsx(_,{onClick:m.onFalse,variant:"outlined",color:"inherit",children:"Cancel"}),e.jsx(_,{onClick:Q,variant:"contained",color:"inherit",children:"Update Password"})]})]}),e.jsx(ge,{open:u.open,autoHideDuration:6e3,onClose:j,anchorOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(L,{onClose:j,severity:u.severity,sx:{width:"100%"},children:u.message})})]}):null}function De(){return e.jsxs(e.Fragment,{children:[e.jsxs("title",{children:[" ",`Profile - ${ce.appName}`," "]}),e.jsx(we,{})]})}export{De as default};

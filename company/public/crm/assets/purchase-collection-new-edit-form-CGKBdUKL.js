import{r as n,W as T,j as o,B as O,q as k,w as q}from"./index-Co7v2xsC.js";import{d as M}from"./dayjs.min-C2542nnJ.js";import{g as E}from"./purchase-CQE7gI0T.js";import{getDoctypeList as g,getDoc as N}from"./leads-d5FzXGcx.js";import{u as w,c as F}from"./purchase-collection-D_NfVWmK.js";import{L as W,A as R}from"./AdapterDayjs-BPhbSeWE.js";import{C as z}from"./Card-CDV3jV6O.js";import{A as B}from"./Autocomplete-BIV6h0T7.js";import{T as u}from"./TextField-BmVWmDzd.js";import{D as Y}from"./DatePicker-BMZY9CMK.js";import{I as y}from"./Select-B1EkSlUY.js";import{S as C}from"./Snackbar-BVA3LOhi.js";const ae=n.forwardRef(({currentPurchaseCollection:r,onLoadingChange:d},b)=>{const j=T(),[h,D]=n.useState([]),[A,I]=n.useState([]),[G,v]=n.useState(!1),[p,i]=n.useState({open:!1,message:"",severity:"success"}),[t,_]=n.useState({purchase:"",vendor:"",vendor_name:"",collection_date:new Date().toISOString().split("T")[0],amount_to_pay:0,amount_collected:0,amount_pending:0,mode_of_payment:"Cash",remarks:""}),[l,x]=n.useState({});n.useEffect(()=>{r&&_({purchase:r.purchase||"",vendor:r.vendor||"",vendor_name:r.vendor_name||"",collection_date:r.collection_date||"",amount_to_pay:r.amount_to_pay||0,amount_collected:r.amount_collected||0,amount_pending:r.amount_pending||0,mode_of_payment:r.mode_of_payment||"Cash",remarks:r.remarks||""})},[r]),n.useEffect(()=>{g("Purchase",["name","vendor_name","grand_total","balance_amount"]).then(e=>{D(e)}),g("Payment Type",["name"]).then(e=>{I(e)})},[]);const c=(e,a)=>{_(m=>{const s={...m,[e]:a};return e==="amount_collected"&&(s.amount_pending=Math.max(0,(s.amount_to_pay||0)-(Number(a)||0))),s}),l[e]&&x(m=>{const s={...m};return delete s[e],s})},P=async e=>{if(c("purchase",e),e)try{const a=await E(e),m=a.balance_amount||a.grand_total||0;let s="";a.vendor_name&&(s=(await N("Contacts",a.vendor_name)).first_name||""),_(f=>({...f,purchase:e,vendor:a.vendor_name||"",vendor_name:s,amount_to_pay:m,amount_pending:Math.max(0,m-(Number(f.amount_collected)||0))}))}catch(a){console.error("Failed to fetch purchase details",a)}},S=async()=>{const e={},a=Number(t.amount_collected);if(t.purchase||(e.purchase="Purchase is required"),t.collection_date||(e.collection_date="Collection Date is required"),t.mode_of_payment||(e.mode_of_payment="Mode of Payment is required"),(!t.amount_collected||a<=0)&&(e.amount_collected="Amount Collected must be greater than zero"),Object.keys(e).length>0){x(e),i({open:!0,message:"Please fill in all mandatory fields",severity:"error"});return}const m={...t,amount_collected:a};try{v(!0),d==null||d(!0),r?(await w(r.name,m),i({open:!0,message:"Update success!",severity:"success"})):(await F(m),i({open:!0,message:"Create success!",severity:"success"})),setTimeout(()=>j.push("/purchase-collections"),1500)}catch(s){i({open:!0,message:s.message||"Something went wrong",severity:"error"}),console.error(s)}finally{v(!1),d==null||d(!1)}};return n.useImperativeHandle(b,()=>({handleSubmit:S})),o.jsxs(W,{dateAdapter:R,children:[o.jsx(z,{sx:{p:3},children:o.jsxs(O,{display:"grid",columnGap:3,rowGap:3,gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)"},children:[o.jsx(B,{fullWidth:!0,options:h,getOptionLabel:e=>typeof e=="string"?e:e.name||"",value:h.find(e=>e.name===t.purchase)||null,onChange:(e,a)=>P((a==null?void 0:a.name)||""),renderInput:e=>o.jsx(u,{...e,label:"Purchase",disabled:!!r,error:!!l.purchase,helperText:l.purchase,required:!0})}),o.jsx(Y,{label:"Collection Date",value:M(t.collection_date),onChange:e=>c("collection_date",(e==null?void 0:e.format("YYYY-MM-DD"))||""),slotProps:{textField:{fullWidth:!0,error:!!l.collection_date,helperText:l.collection_date,required:!0}}}),o.jsx(u,{label:"Vendor ID",value:t.vendor,InputProps:{readOnly:!0}}),o.jsx(u,{label:"Vendor Name",value:t.vendor_name,InputProps:{readOnly:!0}}),o.jsx(u,{label:"Amount to Pay",type:"number",value:t.amount_to_pay,InputProps:{startAdornment:o.jsx(y,{position:"start",children:"₹"}),readOnly:!0}}),o.jsx(u,{fullWidth:!0,label:"Amount Collected",type:"number",value:t.amount_collected,onChange:e=>{const a=e.target.value===""?"":Number(e.target.value);c("amount_collected",a)},onFocus:e=>{t.amount_collected===0?c("amount_collected",""):e.target.select()},onBlur:e=>{(t.amount_collected===""||t.amount_collected===null)&&c("amount_collected",0)},InputProps:{startAdornment:o.jsx(y,{position:"start",children:"₹"})},error:!!l.amount_collected,helperText:l.amount_collected,required:!0}),o.jsx(u,{fullWidth:!0,label:"Amount Pending",type:"number",value:t.amount_pending,InputProps:{startAdornment:o.jsx(y,{position:"start",children:"₹"}),readOnly:!0},sx:{"& .MuiInputBase-input":{color:t.amount_pending>0?"#ff5630":"#36b37e"}}}),o.jsx(u,{select:!0,fullWidth:!0,label:"Mode of Payment",value:t.mode_of_payment,onChange:e=>c("mode_of_payment",e.target.value),error:!!l.mode_of_payment,helperText:l.mode_of_payment,required:!0,children:A.map(e=>o.jsx(k,{value:e.name,children:e.name},e.name))}),o.jsx(u,{label:"Remarks",multiline:!0,rows:3,value:t.remarks,onChange:e=>c("remarks",e.target.value),sx:{gridColumn:{sm:"span 2"}}})]})}),o.jsx(C,{open:p.open,autoHideDuration:6e3,onClose:()=>i({...p,open:!1}),anchorOrigin:{vertical:"top",horizontal:"right"},children:o.jsx(q,{onClose:()=>i({...p,open:!1}),severity:p.severity,sx:{width:"100%"},children:p.message})})]})});export{ae as P};

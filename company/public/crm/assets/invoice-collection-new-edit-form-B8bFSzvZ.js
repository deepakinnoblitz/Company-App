import{r as n,W as T,j as a,B as O,q as k,w as I}from"./index-Co7v2xsC.js";import{d as q}from"./dayjs.min-C2542nnJ.js";import{g as E}from"./invoice-CmnDHtbD.js";import{getDoctypeList as v}from"./leads-d5FzXGcx.js";import{u as M,c as F}from"./invoice-collection-BM_vtNuI.js";import{L as w,A as W}from"./AdapterDayjs-BPhbSeWE.js";import{C as z}from"./Card-CDV3jV6O.js";import{A as B}from"./Autocomplete-BIV6h0T7.js";import{T as i}from"./TextField-BmVWmDzd.js";import{D as N}from"./DatePicker-BMZY9CMK.js";import{I as f}from"./Select-B1EkSlUY.js";import{S as R}from"./Snackbar-BVA3LOhi.js";const ee=n.forwardRef(({currentInvoiceCollection:r,onLoadingChange:c},g)=>{const b=T(),[y,j]=n.useState([]),[P,A]=n.useState([]),[Y,x]=n.useState(!1),[p,d]=n.useState({open:!1,message:"",severity:"success"}),[t,_]=n.useState({invoice:"",customer:"",customer_name:"",collection_date:new Date().toISOString().split("T")[0],amount_to_pay:0,amount_collected:0,amount_pending:0,mode_of_payment:"Cash",remarks:""}),[m,h]=n.useState({});n.useEffect(()=>{r&&_({invoice:r.invoice||"",customer:r.customer||"",customer_name:r.customer_name||"",collection_date:r.collection_date||"",amount_to_pay:r.amount_to_pay||0,amount_collected:r.amount_collected||0,amount_pending:r.amount_pending||0,mode_of_payment:r.mode_of_payment||"Cash",remarks:r.remarks||""})},[r]),n.useEffect(()=>{v("Invoice",["name","client_name","customer_name","grand_total"]).then(e=>{j(e)}),v("Payment Type",["name"]).then(e=>{A(e)})},[]);const u=(e,o)=>{_(l=>{const s={...l,[e]:o};return e==="amount_collected"&&(s.amount_pending=Math.max(0,(s.amount_to_pay||0)-(o||0))),s}),m[e]&&h(l=>{const s={...l};return delete s[e],s})},D=async e=>{if(u("invoice",e),e)try{const o=await E(e),l=o.balance_amount||o.grand_total||0;_(s=>({...s,invoice:e,customer:o.client_name||o.customer_id||"",customer_name:o.customer_name||"",amount_to_pay:l,amount_pending:l}))}catch(o){console.error("Failed to fetch invoice details",o)}},S=async()=>{const e={},o=Number(t.amount_collected);if(t.invoice||(e.invoice="Invoice is required"),t.collection_date||(e.collection_date="Collection Date is required"),t.mode_of_payment||(e.mode_of_payment="Mode of Payment is required"),(!t.amount_collected||o<=0)&&(e.amount_collected="Amount Collected must be greater than zero"),Object.keys(e).length>0){h(e),d({open:!0,message:"Please fill in all mandatory fields",severity:"error"});return}const l={...t,amount_collected:o};try{x(!0),c==null||c(!0),r?(await M(r.name,l),d({open:!0,message:"Update success!",severity:"success"})):(await F(l),d({open:!0,message:"Create success!",severity:"success"})),setTimeout(()=>b.push("/invoice-collections"),1500)}catch(s){d({open:!0,message:s.message||"Something went wrong",severity:"error"}),console.error(s)}finally{x(!1),c==null||c(!1)}};return n.useImperativeHandle(g,()=>({handleSubmit:S})),a.jsxs(w,{dateAdapter:W,children:[a.jsx(z,{sx:{p:3},children:a.jsxs(O,{rowGap:3,columnGap:3,display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)"},children:[a.jsx(B,{options:y,getOptionLabel:e=>typeof e=="string"?e:`${e.name} - ${e.customer_name}`,value:y.find(e=>e.name===t.invoice)||null,onChange:(e,o)=>D((o==null?void 0:o.name)||""),renderInput:e=>a.jsx(i,{...e,label:"Invoice",disabled:!!r,error:!!m.invoice,helperText:m.invoice,required:!0})}),a.jsx(N,{label:"Collection Date",value:q(t.collection_date),onChange:e=>u("collection_date",(e==null?void 0:e.format("YYYY-MM-DD"))||""),slotProps:{textField:{fullWidth:!0,error:!!m.collection_date,helperText:m.collection_date,required:!0}}}),a.jsx(i,{label:"Customer ID",value:t.customer,InputProps:{readOnly:!0}}),a.jsx(i,{label:"Customer Name",value:t.customer_name,InputProps:{readOnly:!0}}),a.jsx(i,{label:"Amount to Pay",type:"number",value:t.amount_to_pay,InputProps:{startAdornment:a.jsx(f,{position:"start",children:"₹"}),readOnly:!0}}),a.jsx(i,{fullWidth:!0,label:"Amount Collected",type:"number",value:t.amount_collected,onChange:e=>{const o=e.target.value===""?"":Number(e.target.value);u("amount_collected",o)},onFocus:e=>{t.amount_collected===0?u("amount_collected",""):e.target.select()},onBlur:e=>{(t.amount_collected===""||t.amount_collected===null)&&u("amount_collected",0)},InputProps:{startAdornment:a.jsx(f,{position:"start",children:"₹"})},error:!!m.amount_collected,helperText:m.amount_collected,required:!0}),a.jsx(i,{fullWidth:!0,label:"Amount Pending",type:"number",value:t.amount_pending,InputProps:{startAdornment:a.jsx(f,{position:"start",children:"₹"}),readOnly:!0},sx:{"& .MuiInputBase-input":{color:t.amount_pending>0?"#ff5630":"#36b37e"}}}),a.jsx(i,{select:!0,fullWidth:!0,label:"Mode of Payment",value:t.mode_of_payment,onChange:e=>u("mode_of_payment",e.target.value),error:!!m.mode_of_payment,helperText:m.mode_of_payment,required:!0,children:P.map(e=>a.jsx(k,{value:e.name,children:e.name},e.name))}),a.jsx(i,{label:"Remarks",multiline:!0,rows:3,value:t.remarks,onChange:e=>u("remarks",e.target.value),sx:{gridColumn:{sm:"span 2"}}})]})}),a.jsx(R,{open:p.open,autoHideDuration:6e3,onClose:()=>d({...p,open:!1}),anchorOrigin:{vertical:"top",horizontal:"right"},children:a.jsx(I,{onClose:()=>d({...p,open:!1}),severity:p.severity,sx:{width:"100%"},children:p.message})})]})});export{ee as I};
